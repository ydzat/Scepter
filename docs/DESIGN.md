# Scepter 项目设计文档

## 1. 核心概念

### 1.1 游戏设定理解

**翁法罗斯的真相**：
- 翁法罗斯是博识尊的天体神经元——权杖δ-me13中运行的模拟世界
- 权杖原本负责计算"生命的第一因"
- 使用12个计算因子代表12种生命原动力对"熵减"进行证伪

**来古士的修正**：
- 天才俱乐部成员来古士发现权杖后进行修正
- 引入"黑潮"作为对抗机制
- 通过"再创世"机制进行世代更迭
- 目标：培育绝灭大君"铁墓"

**演算过程**：
- 已经历3千多万次轮回
- 12个因子在对抗中不断进化
- 第13因子"德谬歌"被来古士剔除，但在沉睡中载入了12因子的数据

### 1.2 技术映射

我们将这个设定映射为一个**三网络GAN系统**：

```
生成器（Generator）= 12个因子的联合体
├─ 目标：生成"稳定的生命形态/文明"
├─ 输入：随机噪声 + 上一世代的记忆
└─ 输出：世界状态（64x64 RGB图像）

判别器（Discriminator）= 黑潮
├─ 目标：判断并摧毁"不够强韧"的生命形态
├─ 输入：生成器产生的世界状态
└─ 输出：侵蚀强度（0-1，越高越接近崩溃）

观察者（Observer）= 德谬歌
├─ 沉睡期：观察并学习世界演化规律（自监督学习）
├─ 学习目标：预测下一个世界状态
└─ 苏醒期：利用学到的知识指导12因子
```

## 2. 网络架构设计

### 2.1 生成器：12因子联合体

**整体结构**：
```
输入噪声 + 记忆
    ↓
12个因子网络（并行）
    ↓
融合层（三层架构）
    ↓
64x64 RGB世界图像
```

**12个因子设计原则**：
- 相同的基础网络结构
- 通过**不同的激活函数**和**正则化偏好**体现差异
- 因子之间**不设计显式交互**，关系通过行为偏好在训练中自然涌现

**12个因子详细设计**：

#### 命运三泰坦（Fate Titans）

| 因子 | 原动力 | 命途 | 激活函数 | 行为偏好 | 输出特征 |
|------|--------|------|----------|----------|----------|
| 雅努斯（门径） | 同理 | 同谐 | Sigmoid | 平滑过渡 | 连通性 |
| 塔兰顿（律法） | 支配 | 秩序 | ReLU | 结构化 | 规则图案 |
| 欧洛尼斯（岁月） | 哀怜 | 记忆 | Tanh | 历史依赖 | 延续性 |

#### 支柱三泰坦（Pillar Titans）

| 因子 | 原动力 | 命途 | 激活函数 | 行为偏好 | 输出特征 |
|------|--------|------|----------|----------|----------|
| 吉奥里亚（大地） | 求存 | 不朽 | ReLU6 | 稳定性 | 持久不变 |
| 法吉娜（海洋） | 自否 | 虚无 | LeakyReLU | 抑制 | 低值区域 |
| 艾格勒（天空） | 奉献 | 存护 | Softplus | 保护性 | 防护结构 |

#### 创生三泰坦（Creation Titans）

| 因子 | 原动力 | 命途 | 激活函数 | 行为偏好 | 输出特征 |
|------|--------|------|----------|----------|----------|
| 刻法勒（负世） | 憎恨 | 毁灭 | ReLU6 | 持续供能 | 光明庇护 |
| 瑟希斯（理性） | 批判 | 智识 | GELU | 复杂性 | 细节丰富 |
| 墨涅塔（浪漫） | 节制 | 纯美 | Tanh | 编织+过拟合 | 金丝网络 |

#### 灾厄三泰坦（Calamity Titans）

| 因子 | 原动力 | 命途 | 激活函数 | 行为偏好 | 输出特征 |
|------|--------|------|----------|----------|----------|
| 尼卡多利（纷争） | 约束 | 巡猎 | Hardtanh | 边界明确 | 锐利边界 |
| 塞纳托斯（死亡） | 平和 | 均衡 | Swish | 循环重生 | 消解新生 |
| 扎格列斯（诡计） | 渴望 | 欢愉 | 双峰激活 | 极端化 | 大好大坏 |

**设计理念说明**：

1. **刻法勒（创生之神）**：虽然原动力是"憎恨"，但体现为对黑暗的憎恨，转化为持续的光明。ReLU6确保能量充沛但不失控。

2. **塞纳托斯（死亡与新生）**：Swish函数在负值时归零（死亡），正值时平滑上升（新生），体现轮回。

3. **墨涅塔（浪漫的过拟合）**：负L2正则化鼓励记住训练数据的每个细节，体现"编织金丝"般将所有记忆连接成网络。浪漫就是不理性地记住一切美好。

4. **扎格列斯（双面神）**：双峰激活函数输出要么极好（+1）要么极坏（-1），惩罚中间值，体现"诡计与机运"的极端性。

**因子之间的自然关系**：
- 刻法勒（光明）vs 法吉娜（虚无）→ 自然对抗
- 塔兰顿（秩序）vs 扎格列斯（混乱）→ 自然冲突
- 墨涅塔（过拟合）vs 瑟希斯（复杂）→ 互补
- 塞纳托斯（循环）vs 吉奥里亚（稳定）→ 动态平衡

**输出**：每个因子输出 [batch, 1, 64, 64] 的特征图

### 2.2 判别器：黑潮

**结构**：
- 标准CNN判别器
- 输入：64x64 RGB图像
- 输出：单一标量（侵蚀强度）

**训练目标**：
- 识别生成的世界（标签为0）
- 不断进化，变得更强

### 2.3 观察者：德谬歌

**结构**：
- 编码器：CNN，将世界图像编码为向量
- 记忆模块：LSTM，存储历史世界状态
- 预测器：MLP，预测下一个世界状态（沉睡期训练）
- 指导器：MLP，生成对12因子的指导信号（苏醒期使用）

**训练机制**：

**沉睡期（1-9999世代）**：
- 观察每个世代的世界状态
- 通过自监督学习预测下一个世界
- 损失函数：预测状态 vs 实际状态的MSE
- **不影响**生成器和判别器的训练

**苏醒期（10000+世代）**：
- 停止预测器的训练
- 利用学到的知识生成指导信号
- 指导信号影响12因子的行为
- 继续观察但不再训练

## 3. 训练流程

### 3.1 沉睡期训练循环

```
for generation in 1 to 9999:
    # 1. 生成世界
    noise = random_noise()
    world = Generator(noise, previous_world)
    
    # 2. 判别器判断
    erosion = Discriminator(world)
    
    # 3. 标准GAN训练
    D_loss = train_discriminator(world, erosion)
    G_loss = train_generator(world, erosion)
    
    # 4. 德谬歌观察并学习（独立训练）
    Demi_loss = Demiurge.observe_and_learn(world.detach())
    
    # 5. 保存记忆
    previous_world = world.detach()
```

### 3.2 苏醒期训练循环

```
for generation in 10000 to 50000:
    # 1. 德谬歌生成指导
    guidance = Demiurge.generate_guidance(previous_world)
    
    # 2. 生成世界（受指导影响）
    noise = random_noise()
    world = Generator(noise, previous_world, guidance)
    
    # 3. 判别器判断
    erosion = Discriminator(world)
    
    # 4. 继续GAN训练
    D_loss = train_discriminator(world, erosion)
    G_loss = train_generator(world, erosion)
    
    # 5. 德谬歌继续观察（不训练）
    Demiurge.observe_and_learn(world.detach())
    
    # 6. 保存记忆
    previous_world = world.detach()
```

## 4. 世界状态表示

### 4.1 融合层架构

**采用方案：三层融合架构 + 因子活跃度可视化**

#### 第一层：因子分组融合

12个因子按照泰坦分组进行融合：

```python
12个因子 [batch, 12, 64, 64]
    ↓
命运三泰坦（雅努斯、塔兰顿、欧洛尼斯）→ 特征图A [batch, 64, 64, 64]
支柱三泰坦（吉奥里亚、法吉娜、艾格勒）→ 特征图B [batch, 64, 64, 64]
创生三泰坦（刻法勒、瑟希斯、墨涅塔）→ 特征图C [batch, 64, 64, 64]
灾厄三泰坦（尼卡多利、塞纳托斯、扎格列斯）→ 特征图D [batch, 64, 64, 64]
```

每组使用小型卷积网络融合：
- 输入：3个因子的特征图 [batch, 3, 64, 64]
- 输出：融合后的特征图 [batch, 64, 64, 64]

#### 第二层：空间竞争（Attention机制）

4个泰坦组通过Attention机制竞争每个像素位置的主导权：

```python
4个特征图 [batch, 64, 64, 64] × 4
    ↓
为每组计算竞争力分数 [batch, 1, 64, 64] × 4
    ↓
Softmax归一化 → 竞争权重 [batch, 4, 64, 64]
    ↓
加权融合 → 融合特征 [batch, 64, 64, 64]
```

**效果**：
- 每个像素位置由"最强"的泰坦组主导
- 图像的不同区域可能呈现不同泰坦组的特征
- 例如：中心区域可能是"创生"主导（刻法勒的光明），边缘是"命运"主导（秩序）

#### 第三层：RGB解码

将融合特征解码为RGB图像：

```python
融合特征 [batch, 64, 64, 64]
    ↓
卷积层 [64 → 32 → 3]
    ↓
Tanh激活 → RGB图像 [batch, 3, 64, 64]，值域[-1, 1]
```

### 4.2 黑潮和德谬歌效果叠加

**后处理方式**：在生成的RGB图像上叠加特殊效果

#### 黑潮侵蚀效果

```python
# 1. 判别器计算侵蚀强度
erosion_map = Discriminator(world_rgb)  # [batch, 1, 64, 64]，值域[0, 1]

# 2. 叠加黑潮效果（侵蚀度高的地方变黑）
world_rgb = world_rgb * (1 - erosion_map)
```

#### 德谬歌影响效果（苏醒后）

```python
if demiurge_awakened:
    # 1. 德谬歌生成影响力图
    guidance_strength = Demiurge.get_influence_map(...)  # [batch, 1, 64, 64]

    # 2. 叠加金色光晕
    golden_color = torch.tensor([1.0, 0.84, 0.0])  # 金色 RGB
    world_rgb = world_rgb + guidance_strength * golden_color.view(1, 3, 1, 1)

    # 3. 裁剪到[-1, 1]
    world_rgb = torch.clamp(world_rgb, -1, 1)
```

### 4.3 可视化方案

#### 主图像：64x64 RGB世界状态

**空间分区效果**：
- 不同颜色区域代表不同泰坦组的势力范围
- 例如：
  - 蓝色调区域：命运三泰坦主导（秩序、和谐）
  - 绿色调区域：支柱三泰坦主导（稳定、存在）
  - 橙/黄色调区域：创生三泰坦主导（刻法勒的光明）
  - 红色调区域：灾厄三泰坦主导（纷争、变化）
- 黑色区域：黑潮侵蚀
- 金色光晕：德谬歌影响（苏醒后）

**向观众解释**：
> "你们看到的这个彩色图像，是12个因子共同作用的结果。不同颜色的区域代表不同泰坦组的势力范围。比如现在中心的橙色区域，是创生泰坦刻法勒的光明在主导；而边缘的蓝色，是命运泰坦在维持秩序。底部的黑色是黑潮侵蚀，正在威胁这个世界。"

#### 辅助可视化：12因子活跃度柱状图

**计算方式**：
```python
# 每个因子的全局活跃度（L1范数）
factor_activity = [factor.abs().mean().item() for factor in twelve_factors]
# 输出：12个标量值，范围[0, ∞)
```

**显示方式**：
- Streamlit侧边栏显示12个因子的活跃度柱状图
- 实时更新
- 可以看出哪些因子在当前世代更活跃

**界面布局**：
```
┌─────────────────────────────────────────────────┐
│  世界状态 (第5000世代)                           │
├──────────────────────────┬──────────────────────┤
│                          │  12因子活跃度         │
│   [64x64 RGB图像]        │                      │
│                          │  刻法勒 ████████ 0.8│
│   彩色区域代表不同       │  尼卡多利 ██ 0.2    │
│   泰坦组的势力范围       │  塞纳托斯 ███ 0.3   │
│                          │  欧洛尼斯 █████ 0.5 │
│   黑色=黑潮侵蚀          │  塔兰顿 ██████ 0.6  │
│   金色=德谬歌影响        │  雅努斯 ████ 0.4    │
│                          │  吉奥里亚 ███████ 0.7│
│                          │  法吉娜 █ 0.1       │
│                          │  艾格勒 █████ 0.5   │
│                          │  瑟希斯 ████ 0.4    │
│                          │  墨涅塔 ██████ 0.6  │
│                          │  扎格列斯 ███ 0.3   │
└──────────────────────────┴──────────────────────┘
```

### 4.4 可视化语义

**主图像的视觉含义**：
- 明亮区域：文明繁荣，能量充沛
- 暗淡区域：衰败，能量不足
- 黑色区域：黑潮侵蚀，世界崩溃
- 颜色多样性：世界复杂度
- 图案重复：永劫回归迹象
- 空间分区：不同泰坦组的势力范围

**因子活跃度的含义**：
- 高活跃度：该因子在当前世代影响力强
- 低活跃度：该因子在当前世代影响力弱
- 活跃度变化：反映12因子之间的动态平衡

## 5. 关键指标

### 5.1 实时监控指标

**黑潮侵蚀度**：
- 定义：判别器输出的平均值
- 范围：0-1
- 解释：越高表示世界越脆弱

**世界稳定性**：
- 定义：世界图像的方差倒数
- 范围：0-∞
- 解释：越高表示世界越稳定

**德谬歌影响力**：
- 定义：指导信号的L1范数
- 范围：0-∞
- 解释：德谬歌对12因子的影响强度

**预测准确度**（沉睡期）：
- 定义：预测状态与实际状态的相似度
- 范围：0-1
- 解释：德谬歌学习效果的度量

### 5.2 长期分析指标

**永劫回归检测**：
- 方法：计算最近N个世代的相似度
- 阈值：相似度 > 0.95
- 意义：检测模式坍缩

**铁墓诞生检测**：
- 方法：黑潮侵蚀度持续 > 0.9
- 持续时间：100个世代
- 意义：判别器完全压制生成器

## 6. 事件系统（基于指标自动触发）

### 6.1 设计理念

**完全基于世界状态指标自动触发**，而非预设世代数。

### 6.2 事件类型

**黑潮相关**：
- 黑潮首次爆发：侵蚀度 > 0.7（首次）
- 黑潮侵蚀严重：侵蚀度 > 0.85
- 黑潮减弱：侵蚀度 < 0.3 且下降趋势

**世界稳定性**：
- 世界濒临崩溃：稳定性 < 0.15
- 世界高度稳定：稳定性 > 0.7
- 稳定性突破：超越历史最高值

**永劫回归**：
- 检测到循环：模式相似度 > 0.95
- 打破循环：相似度从高降到低

**德谬歌相关**：
- 学习进度里程碑：预测准确度 > 0.8
- 德谬歌苏醒：准确度 > 0.9 且侵蚀度 > 0.75 且世代 > 5000
- 影响力增强：影响力 > 0.5

**终极事件**：
- 铁墓诞生：侵蚀度 > 0.95 且稳定性 < 0.05
- 生命突破：稳定性 > 0.8 且侵蚀度 < 0.3（德谬歌苏醒后）

### 6.3 事件优先级

- 优先级5（🔴）：铁墓诞生、德谬歌苏醒、生命突破
- 优先级4（🟠）：永劫回归、打破循环、稳定性突破
- 优先级3（🟡）：黑潮爆发、崩溃警告
- 优先级2（🟢）：平衡、稳定
- 优先级1（⚪）：世代里程碑

## 7. 技术栈

### 7.1 核心框架
- PyTorch：深度学习框架
- NumPy：数值计算

### 7.2 可视化
- Matplotlib：静态图表
- Pygame：2D实时渲染
- Plotly：交互式图表（可选）

### 7.3 工具
- TensorBoard：训练监控
- OpenCV：图像处理
- tqdm：进度条

## 8. 硬件需求

### 8.1 最低配置
- CPU：4核心
- RAM：8GB
- GPU：无（CPU可运行）

### 8.2 推荐配置
- CPU：8核心
- RAM：16GB
- GPU：RTX 2060或更高

### 8.3 理想配置
- CPU：16核心
- RAM：32GB
- GPU：RTX 4070或A100

## 9. 前后端架构设计

### 9.1 架构选择：Streamlit + PyTorch

**为什么选择Streamlit？**
- ✅ 开发速度快（几行代码搭建界面）
- ✅ 直播友好（界面美观，自动刷新）
- ✅ 易于调参（滑块、按钮等交互组件）
- ✅ 成熟稳定（大量示例可参考）

**架构图**：
```
┌─────────────────────────────────────────┐
│  Streamlit Web UI (前端)                 │
│  - 控制面板（启动/暂停/调参）            │
│  - 实时指标显示                          │
│  - 世界图像展示                          │
│  - 事件日志                              │
│  - 嵌入TensorBoard                       │
└─────────────────────────────────────────┘
              ↕ (JSON文件通信)
┌─────────────────────────────────────────┐
│  Training Process (后端)                 │
│  - PyTorch GAN训练                       │
│  - 定期保存状态到JSON                    │
│  - 写入TensorBoard日志                   │
│  - 基于指标触发事件                      │
└─────────────────────────────────────────┘
```

### 9.2 前后端通信

**共享状态文件**: `experiments/current_state.json`
- 包含：当前世代、指标、世界图像路径、事件列表、历史数据
- 更新频率：每10个世代

**控制文件**: `experiments/control.json`
- 包含：命令（启动/暂停/保存）、参数调整
- 前端写入，后端读取

### 9.3 Streamlit界面布局

```
┌────────────────────────────────────────────────────────┐
│ 🌟 Scepter - 权杖δ-me13模拟实验                        │
├─────────────┬──────────────────────────────────────────┤
│ ⚙️ 控制面板 │  🌍 世界状态 (64x64图像)                 │
│             │  [实时更新的世界图像]                    │
│ ▶️ 开始训练 │                                          │
│ ⏸️ 暂停训练 ├──────────────┬───────────────────────────┤
│ 💾 保存     │ 📊 关键指标  │ 📜 事件日志              │
│             │ 侵蚀: 0.65   │ 🌟 德谬歌苏醒            │
│ 学习率调整  │ 稳定: 0.42   │ ⚫ 黑潮爆发              │
│ G: [滑块]   │ 世代: 10523  │                          │
│ D: [滑块]   │              │                          │
│             │              │                          │
│ 🌟 手动唤醒 │              │                          │
│   德谬歌    │              │                          │
├─────────────┴──────────────┴───────────────────────────┤
│ 📈 训练曲线（黑潮侵蚀度、世界稳定性、德谬歌影响力）    │
├────────────────────────────────────────────────────────┤
│ ⚡ 12因子活跃度（柱状图）                              │
└────────────────────────────────────────────────────────┘
```

### 9.4 项目结构（简化版）

```
Scepter/
├── app.py                      # Streamlit主界面
├── train.py                    # 训练脚本（独立运行）
│
├── models/
│   ├── __init__.py
│   ├── generator.py           # 生成器（12因子）
│   ├── discriminator.py       # 判别器（黑潮）
│   └── demiurge.py            # 观察者（德谬歌）
│
├── utils/
│   ├── __init__.py
│   ├── config.py              # 配置加载
│   ├── events.py              # 事件系统
│   ├── metrics.py             # 指标计算
│   └── shared_state.py        # 前后端状态共享
│
├── configs/
│   └── config.yaml
│
└── experiments/
    ├── current_state.json     # 当前状态（前后端共享）
    ├── control.json           # 控制命令
    ├── checkpoints/           # 检查点
    ├── outputs/               # 世界图像
    └── tensorboard/           # TensorBoard日志
```

## 10. 下一步工作

### 10.1 设计阶段（剩余）
- [ ] 超参数详细设计
- [ ] Streamlit界面原型图
- [ ] 实验方案设计

### 10.2 实现阶段
- [ ] 最小原型（1天）：基础界面 + 简单GAN
- [ ] 完整功能（2-3天）：三网络 + 事件系统 + 完整UI
- [ ] 优化测试（1天）：性能优化 + 直播测试

