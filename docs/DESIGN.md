# Scepter 项目设计文档

## 1. 核心概念

### 1.1 游戏设定理解

**翁法罗斯的真相**：
- 翁法罗斯是博识尊的天体神经元——权杖δ-me13中运行的模拟世界
- 权杖原本负责计算"生命的第一因"
- 使用12个计算因子代表12种生命原动力对"熵减"进行证伪

**来古士的修正**：
- 天才俱乐部成员来古士发现权杖后进行修正
- 引入"黑潮"作为对抗机制
- 通过"再创世"机制进行世代更迭
- 目标：培育绝灭大君"铁墓"

**演算过程**：
- 已经历3千多万次轮回
- 12个因子在对抗中不断进化
- 第13因子"德谬歌"被来古士剔除，但在沉睡中载入了12因子的数据

### 1.2 技术映射

我们将这个设定映射为一个**三网络GAN系统**：

```
生成器（Generator）= 12个因子的联合体
├─ 目标：生成"稳定的生命形态/文明"
├─ 输入：随机噪声 + 上一世代的记忆
└─ 输出：世界状态（64x64 RGB图像）

判别器（Discriminator）= 黑潮
├─ 目标：判断并摧毁"不够强韧"的生命形态
├─ 输入：生成器产生的世界状态
└─ 输出：侵蚀强度（0-1，越高越接近崩溃）

观察者（Observer）= 德谬歌
├─ 沉睡期：观察并学习世界演化规律（自监督学习）
├─ 学习目标：预测下一个世界状态
└─ 苏醒期：利用学到的知识指导12因子
```

## 2. 网络架构设计

### 2.1 生成器：12因子联合体

**结构**：
- 12个独立的小型神经网络（每个代表一个因子/泰坦）
- 融合层：将12个因子的输出合并
- 记忆机制：融合上一世代的世界状态

**12个因子对应**：
1. 刻法勒（负世）- 憎恨/毁灭
2. 尼卡多利（纷争）- 约束/巡猎
3. 塞纳托斯（死亡）- 平和/均衡
4. 欧洛尼斯（岁月）- 哀怜/记忆
5. 塔兰顿（律法）- 支配/秩序
6. 雅努斯（门径）- 同理/同谐
7. 吉奥里亚（大地）- 求存/不朽
8. 法吉娜（海洋）- 自否/虚无
9. 艾格勒（天空）- 奉献/存护
10. 瑟希斯（理性）- 批判/智识
11. 墨涅塔（浪漫）- 节制/纯美
12. 扎格列斯（诡计）- 渴望/欢愉

**输出**：64x64 RGB图像，代表世界状态

### 2.2 判别器：黑潮

**结构**：
- 标准CNN判别器
- 输入：64x64 RGB图像
- 输出：单一标量（侵蚀强度）

**训练目标**：
- 识别生成的世界（标签为0）
- 不断进化，变得更强

### 2.3 观察者：德谬歌

**结构**：
- 编码器：CNN，将世界图像编码为向量
- 记忆模块：LSTM，存储历史世界状态
- 预测器：MLP，预测下一个世界状态（沉睡期训练）
- 指导器：MLP，生成对12因子的指导信号（苏醒期使用）

**训练机制**：

**沉睡期（1-9999世代）**：
- 观察每个世代的世界状态
- 通过自监督学习预测下一个世界
- 损失函数：预测状态 vs 实际状态的MSE
- **不影响**生成器和判别器的训练

**苏醒期（10000+世代）**：
- 停止预测器的训练
- 利用学到的知识生成指导信号
- 指导信号影响12因子的行为
- 继续观察但不再训练

## 3. 训练流程

### 3.1 沉睡期训练循环

```
for generation in 1 to 9999:
    # 1. 生成世界
    noise = random_noise()
    world = Generator(noise, previous_world)
    
    # 2. 判别器判断
    erosion = Discriminator(world)
    
    # 3. 标准GAN训练
    D_loss = train_discriminator(world, erosion)
    G_loss = train_generator(world, erosion)
    
    # 4. 德谬歌观察并学习（独立训练）
    Demi_loss = Demiurge.observe_and_learn(world.detach())
    
    # 5. 保存记忆
    previous_world = world.detach()
```

### 3.2 苏醒期训练循环

```
for generation in 10000 to 50000:
    # 1. 德谬歌生成指导
    guidance = Demiurge.generate_guidance(previous_world)
    
    # 2. 生成世界（受指导影响）
    noise = random_noise()
    world = Generator(noise, previous_world, guidance)
    
    # 3. 判别器判断
    erosion = Discriminator(world)
    
    # 4. 继续GAN训练
    D_loss = train_discriminator(world, erosion)
    G_loss = train_generator(world, erosion)
    
    # 5. 德谬歌继续观察（不训练）
    Demiurge.observe_and_learn(world.detach())
    
    # 6. 保存记忆
    previous_world = world.detach()
```

## 4. 世界状态表示

### 4.1 图像编码方案

**64x64 RGB图像**，每个通道代表不同维度：

**方案A：因子影响力编码**
- R通道：前4个因子的影响力叠加
- G通道：中间4个因子的影响力叠加
- B通道：后4个因子的影响力叠加

**方案B：抽象属性编码**
- R通道：秩序度（0=混乱，255=秩序）
- G通道：生命力（0=死寂，255=繁荣）
- B通道：稳定性（0=崩溃，255=稳定）

**方案C：混合编码**（推荐）
- 使用方案B作为基础
- 黑色区域代表黑潮侵蚀
- 金色光晕代表德谬歌的影响（苏醒后）

### 4.2 可视化映射

- 明亮区域：文明繁荣
- 暗淡区域：衰败
- 黑色区域：黑潮侵蚀
- 颜色多样性：世界复杂度
- 图案重复：永劫回归迹象

## 5. 关键指标

### 5.1 实时监控指标

**黑潮侵蚀度**：
- 定义：判别器输出的平均值
- 范围：0-1
- 解释：越高表示世界越脆弱

**世界稳定性**：
- 定义：世界图像的方差倒数
- 范围：0-∞
- 解释：越高表示世界越稳定

**德谬歌影响力**：
- 定义：指导信号的L1范数
- 范围：0-∞
- 解释：德谬歌对12因子的影响强度

**预测准确度**（沉睡期）：
- 定义：预测状态与实际状态的相似度
- 范围：0-1
- 解释：德谬歌学习效果的度量

### 5.2 长期分析指标

**永劫回归检测**：
- 方法：计算最近N个世代的相似度
- 阈值：相似度 > 0.95
- 意义：检测模式坍缩

**铁墓诞生检测**：
- 方法：黑潮侵蚀度持续 > 0.9
- 持续时间：100个世代
- 意义：判别器完全压制生成器

## 6. 事件系统（基于指标自动触发）

### 6.1 设计理念

**完全基于世界状态指标自动触发**，而非预设世代数。

### 6.2 事件类型

**黑潮相关**：
- 黑潮首次爆发：侵蚀度 > 0.7（首次）
- 黑潮侵蚀严重：侵蚀度 > 0.85
- 黑潮减弱：侵蚀度 < 0.3 且下降趋势

**世界稳定性**：
- 世界濒临崩溃：稳定性 < 0.15
- 世界高度稳定：稳定性 > 0.7
- 稳定性突破：超越历史最高值

**永劫回归**：
- 检测到循环：模式相似度 > 0.95
- 打破循环：相似度从高降到低

**德谬歌相关**：
- 学习进度里程碑：预测准确度 > 0.8
- 德谬歌苏醒：准确度 > 0.9 且侵蚀度 > 0.75 且世代 > 5000
- 影响力增强：影响力 > 0.5

**终极事件**：
- 铁墓诞生：侵蚀度 > 0.95 且稳定性 < 0.05
- 生命突破：稳定性 > 0.8 且侵蚀度 < 0.3（德谬歌苏醒后）

### 6.3 事件优先级

- 优先级5（🔴）：铁墓诞生、德谬歌苏醒、生命突破
- 优先级4（🟠）：永劫回归、打破循环、稳定性突破
- 优先级3（🟡）：黑潮爆发、崩溃警告
- 优先级2（🟢）：平衡、稳定
- 优先级1（⚪）：世代里程碑

## 7. 技术栈

### 7.1 核心框架
- PyTorch：深度学习框架
- NumPy：数值计算

### 7.2 可视化
- Matplotlib：静态图表
- Pygame：2D实时渲染
- Plotly：交互式图表（可选）

### 7.3 工具
- TensorBoard：训练监控
- OpenCV：图像处理
- tqdm：进度条

## 8. 硬件需求

### 8.1 最低配置
- CPU：4核心
- RAM：8GB
- GPU：无（CPU可运行）

### 8.2 推荐配置
- CPU：8核心
- RAM：16GB
- GPU：RTX 2060或更高

### 8.3 理想配置
- CPU：16核心
- RAM：32GB
- GPU：RTX 4070或A100

## 9. 前后端架构设计

### 9.1 架构选择：Streamlit + PyTorch

**为什么选择Streamlit？**
- ✅ 开发速度快（几行代码搭建界面）
- ✅ 直播友好（界面美观，自动刷新）
- ✅ 易于调参（滑块、按钮等交互组件）
- ✅ 成熟稳定（大量示例可参考）

**架构图**：
```
┌─────────────────────────────────────────┐
│  Streamlit Web UI (前端)                 │
│  - 控制面板（启动/暂停/调参）            │
│  - 实时指标显示                          │
│  - 世界图像展示                          │
│  - 事件日志                              │
│  - 嵌入TensorBoard                       │
└─────────────────────────────────────────┘
              ↕ (JSON文件通信)
┌─────────────────────────────────────────┐
│  Training Process (后端)                 │
│  - PyTorch GAN训练                       │
│  - 定期保存状态到JSON                    │
│  - 写入TensorBoard日志                   │
│  - 基于指标触发事件                      │
└─────────────────────────────────────────┘
```

### 9.2 前后端通信

**共享状态文件**: `experiments/current_state.json`
- 包含：当前世代、指标、世界图像路径、事件列表、历史数据
- 更新频率：每10个世代

**控制文件**: `experiments/control.json`
- 包含：命令（启动/暂停/保存）、参数调整
- 前端写入，后端读取

### 9.3 Streamlit界面布局

```
┌────────────────────────────────────────────────────────┐
│ 🌟 Scepter - 权杖δ-me13模拟实验                        │
├─────────────┬──────────────────────────────────────────┤
│ ⚙️ 控制面板 │  🌍 世界状态 (64x64图像)                 │
│             │  [实时更新的世界图像]                    │
│ ▶️ 开始训练 │                                          │
│ ⏸️ 暂停训练 ├──────────────┬───────────────────────────┤
│ 💾 保存     │ 📊 关键指标  │ 📜 事件日志              │
│             │ 侵蚀: 0.65   │ 🌟 德谬歌苏醒            │
│ 学习率调整  │ 稳定: 0.42   │ ⚫ 黑潮爆发              │
│ G: [滑块]   │ 世代: 10523  │                          │
│ D: [滑块]   │              │                          │
│             │              │                          │
│ 🌟 手动唤醒 │              │                          │
│   德谬歌    │              │                          │
├─────────────┴──────────────┴───────────────────────────┤
│ 📈 训练曲线（黑潮侵蚀度、世界稳定性、德谬歌影响力）    │
├────────────────────────────────────────────────────────┤
│ ⚡ 12因子活跃度（柱状图）                              │
└────────────────────────────────────────────────────────┘
```

### 9.4 项目结构（简化版）

```
Scepter/
├── app.py                      # Streamlit主界面
├── train.py                    # 训练脚本（独立运行）
│
├── models/
│   ├── __init__.py
│   ├── generator.py           # 生成器（12因子）
│   ├── discriminator.py       # 判别器（黑潮）
│   └── demiurge.py            # 观察者（德谬歌）
│
├── utils/
│   ├── __init__.py
│   ├── config.py              # 配置加载
│   ├── events.py              # 事件系统
│   ├── metrics.py             # 指标计算
│   └── shared_state.py        # 前后端状态共享
│
├── configs/
│   └── config.yaml
│
└── experiments/
    ├── current_state.json     # 当前状态（前后端共享）
    ├── control.json           # 控制命令
    ├── checkpoints/           # 检查点
    ├── outputs/               # 世界图像
    └── tensorboard/           # TensorBoard日志
```

## 10. 下一步工作

### 10.1 设计阶段（剩余）
- [ ] 超参数详细设计
- [ ] Streamlit界面原型图
- [ ] 实验方案设计

### 10.2 实现阶段
- [ ] 最小原型（1天）：基础界面 + 简单GAN
- [ ] 完整功能（2-3天）：三网络 + 事件系统 + 完整UI
- [ ] 优化测试（1天）：性能优化 + 直播测试

